# Inventory proposal format audit

## Live evidence
- Screenshot: /mnt/data/7c1c387d-7dcf-4347-9599-a8b70bc2d5a7.png

## 1. End-to-end data path (file:line anchors)
1. **Request entrypoint** – `app/api/routers/chat.py:35-69` exposes `/chat/inventory`, enforces `mode='fill'`/`thread_id`, and delegates to `ChatService.inventory_agent.handle_fill` so the order-to-sale intent is handled by the inventory-specific agent rather than the generic `/chat` branch.
2. **Parsing + normalization** – `InventoryAgent.handle_fill` (`app/services/inventory_agent.py:152-267`) calls the LLM-backed helpers in `app/services/inventory_parse_service.py:12-33` to extract new drafts or edit ops, then hands the raw drafts to `normalize_items` (`app/services/inventory_normalizer.py:1-38`) to canonicalize quantities/units before turning them into actions.
3. **Proposal creation** – The same method at `app/services/inventory_agent.py:201-267` builds `actions`, saves them in `ProposalStore`, and returns `ChatResponse(reply_text=..., confirmation_required=True, proposal_id=<uuid>, proposed_actions=actions)` alongside any warning text from `_render_proposal`. The measurement notes are attached to each `ProposedInventoryEventAction` before the response goes out (`app/services/inventory_agent.py:519-528`).
4. **Response schema** – Web clients rely on `ChatResponse` fields defined in `app/schemas.py:222-227` and locked by `Contracts/physics.yaml:527-540` (`reply_text`, `confirmation_required`, `proposal_id`, `proposed_actions`, `mode`).
5. **Frontend parsing/render entrypoint** – `web/src/main.ts:1161-1187` posts to `/chat/inventory`, grabs the JSON, runs `formatProposalSummary`, merges that summary with `reply_text`, and then calls `updateHistory()` plus `renderProposal()` while storing `state.proposalId`/`state.proposedActions` for later confirmation.
6. **Final DOM render** – `renderDuetHistory()` in `web/src/main.ts:517-535` rewrites `#duet-history-list` from `duetState.history`, and `setBubbleText()` (`web/src/main.ts:538-548`) injects the latest assistant text (which now contains the proposal summary) into the duet bubble.

## 2. Exact string/format origin
- **Em-dash separators** – `web/src/proposalRenderer.ts:60-83` builds `components` for each `InventoryEvent`, then returns `• ${components.join(" — ")}`, so every `—` in the UI line is inserted client-side while joining `item_name`, `quantity`, and the optional note.
- **`weight_g=` / `volume_ml=` suffixes** – `_measurement_note_value` (`app/services/inventory_agent.py:972-979`) emits `weight_g=...` or `volume_ml=...` for g/ml units, and when the dedupe logic at `app/services/inventory_agent.py:519-528` sees an existing action it appends that string to `action.event.note`, which is later dropped into the UI via `formatInventoryAction`.
- **Count-only blank segment** – Because `_measurement_note_value` returns `None` for `unit == "count"`, `action.event.note` is empty and `formatInventoryAction` never pushes a third component (`notePieces.length` guards that push). The UI therefore renders only `item_name` + `quantity`, and the “missing” em-dash comes from the fact that `components.join(" — ")` only joins what exists (no blank string is inserted), so count lines simply lack the third segment rather than showing `weight_g=`.

## 3. Classification of what’s driving the ugliness
- **Frontend formats display lines from structured fields.** The backend only supplies structured `InventoryEventCreateRequest` objects (item, quantity, unit, optional `note`) plus the `reply_text` string, but all human-readable proposal lines are assembled inside `formatProposalSummary`/`formatInventoryAction` (`web/src/proposalRenderer.ts:60-95`). The string that ends up in the Dev Panel is created right before `updateHistory` rewrites the history list (`web/src/main.ts:1161-1187`), proving the UI is responsible for joining the segments and adding em dashes.

## 4. Smallest-change candidates
1. **UI-friendly measurement labels** – Update `formatInventoryAction` (`web/src/proposalRenderer.ts:60-83`) to translate `weight_g=`/`volume_ml=` tokens into `500 g` / `150 mL` (or drop them entirely) before joining the components. This is a UI-only formatting change with no schema impact, and it keeps the backend note strings untouched while eliminating the literal `weight_g=` noise.
2. **Backend note throttling** – Adjust `_measurement_note_value` + the call site at `app/services/inventory_agent.py:519-528, 972-979` to skip stacking another `note` when the measurement is already captured by `quantity`/`unit` (or reserve the note for extra metadata). This reduces the note text sent to the client without adding fields to `ChatResponse`; the change stays within the existing optional `InventoryEvent.note` contract but would remove the redundant `weight_g=`/`volume_ml=` entries across both history and proposal payloads.
3. **UI guard for empty third segments** – Extend `formatProposalSummary` / `formatInventoryAction` (`web/src/proposalRenderer.ts:60-95`) so that when `note` is either missing or consists of only the measurement key (e.g., `weight_g=` with no digits), the component is dropped before `join`. This is a UI-only tweak that ensures count-only items never render a dangling dash and keeps `proposalSummary` logic centralized.
